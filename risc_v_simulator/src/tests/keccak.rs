use crate::{abstractions::memory::{AccessType, MemorySource}, cycle::status_registers::TrapReason, delegations::DelegationsCSRProcessor};
use core::array::from_fn;
use super::*;

#[test]
fn test_keccak() {
    // for (i, line) in KECCAK_F1600_ASM.lines().enumerate() {
    //     let line = line.trim();
    //     println!("{i:3}> {line}");
    // }

    // old simulator
    let mut state_oldisa = RiscV32State::<IMStandardIsaConfig>::initial(INITIAL_PC);
    let mut state_newunrolled = RiscV32StateForUnrolledProver::<IMStandardIsaConfig>::initial(INITIAL_PC);

    // feed ROM/RAM + set state address
    let (memory_original, state_addr) = {
        const MEMORY_BYTE_SIZE: usize = 1<<22;
        const ROM_ENTRY_ADDR: u32 = INITIAL_PC; // seems to be default for simulator
        const RAM_ENTRY_ADDR: u32 = 1 << 21; // seems to be default for simulator
        let mut memory = VectorMemoryImpl::new_for_byte_size(MEMORY_BYTE_SIZE);
        memory.load_image(ROM_ENTRY_ADDR, KECCAK_F1600_BIN.iter().flat_map(|w| w.to_le_bytes()));
        for i in 0..30 {
            memory.populate(RAM_ENTRY_ADDR + (i*2)*4 , KECCAK_STATE_INPUT[i as usize] as u32);
            memory.populate(RAM_ENTRY_ADDR + (i*2+1)*4 , (KECCAK_STATE_INPUT[i as usize]>>32) as u32);
        }
        (memory, RAM_ENTRY_ADDR)
    };
    
    // TODO TRACER
    // use tracer;
    // let mut tracer = ExecutionFriendlyTracer;
    // let mut tracer = GPUFriendlyTracer;

    // run SIMULATOR
    state_oldisa.registers[10] = state_addr; // this is where binary expects state addr
    state_newunrolled.registers[10] = state_addr; // this is where binary expects state addr
    let mut memory_oldisa = memory_original.clone();
    let mut memory_newunrolled = memory_original;
    for i in 0..KECCAK_F1600_BIN.len() {
        state_oldisa.cycle(&mut memory_oldisa, &mut (), &mut NoMMU::default(), &mut ZeroedSource);
    }
    println!("> done with normal tracer");
    // TODO: shouldn't this be using the struct in unrolled delegations?? 
    state_newunrolled.run_cycles(&mut memory_newunrolled, &mut (), &mut ZeroedSource, &mut DelegationsCSRProcessor, KECCAK_F1600_BIN.len());
    println!("> done with unrolled tracer");

    // get RAM
    let state_output_oldisa: [u64; 30] = {
        let state_output_u32: [u32; 30*2] = from_fn(|i| memory_oldisa.get(state_addr as u64 + i as u64 *4, AccessType::MemLoad, &mut TrapReason::NoTrap));
        from_fn(|i| state_output_u32[i*2] as u64 | (state_output_u32[i*2 + 1] as u64)<<32 )
    };
    let state_output_newunrolled: [u64; 30] = {
        let state_output_u32: [u32; 30*2] = from_fn(|i| memory_newunrolled.get(state_addr as u64 + i as u64 *4, AccessType::MemLoad, &mut TrapReason::NoTrap));
        from_fn(|i| state_output_u32[i*2] as u64 | (state_output_u32[i*2 + 1] as u64)<<32 )
    };
    // println!("> EXPECTED STATE OUT: {:?}", &KECCAK_STATE_OUTPUT[25..]);
    // println!("> state_output (old): {:?}", &state_output_oldisa[25..]);
    // println!("> state_output (new): {:?}", &state_output_newunrolled[25..]);
    assert!(state_output_oldisa == KECCAK_STATE_OUTPUT);
    assert!(state_output_newunrolled == KECCAK_STATE_OUTPUT);
}

const KECCAK_STATE_INPUT: [u64; 30] = [
    0xF1258F7940E1DDE7,
    0x84D5CCF933C0478A,
    0xD598261EA65AA9EE,
    0xBD1547306F80494D,
    0x8B284E056253D057,
    0xFF97A42D7F8E6FD4,
    0x90FEE5A0A44647C4,
    0x8C5BDA0CD6192E76,
    0xAD30A6F71B19059C,
    0x30935AB7D08FFC64,
    0xEB5AA93F2317D635,
    0xA9A6E6260D712103,
    0x81A57C16DBCF555F,
    0x43B831CD0347C826,
    0x01F22F1A11A5569F,
    0x05E5635A21D9AE61,
    0x64BEFEF28CC970F2,
    0x613670957BC46611,
    0xB87C5A554FD00ECB,
    0x8C3EE88A1CCF32C8,
    0x940C7922AE3A2614,
    0x1841F924A2C509E4,
    0x16F53526E70465C2,
    0x75F644E97F30A13B,
    0xEAF1FF7B5CECA249,
    0,0,0,0,0
];
const KECCAK_STATE_OUTPUT: [u64; 30] = [
    0x2D5C954DF96ECB3C,
    0x6A332CD07057B56D,
    0x093D8D1270D76B6C,
    0x8A20D9B25569D094,
    0x4F9C4F99E5E7F156,
    0xF957B9A2DA65FB38,
    0x85773DAE1275AF0D,
    0xFAF4F247C3D810F7,
    0x1F1B9EE6F79A8759,
    0xE4FECC0FEE98B425,
    0x68CE61B6B9CE68A1,
    0xDEEA66C4BA8F974F,
    0x33C43D836EAFB1F5,
    0xE00654042719DBD9,
    0x7CF8A9F009831265,
    0xFD5449A6BF174743,
    0x97DDAD33D8994B40,
    0x48EAD5FC5D0BE774,
    0xE3B8C8EE55B7B03C,
    0x91A0226E649E42E9,
    0x900E3129E7BADD7B,
    0x202A9EC5FAA3CCE8,
    0x5B3402464E1C3DB6,
    0x609F4E62A44C1059,
    0x20D06CD26A8FBF5C,
    6580920217245585938,
    9271719542500068512,
    10380288247186775419,
    17560361628436099611,
    2273704821156327310,
];
const KECCAK_F1600_BIN: &[u32] = &[
    329107,
    2164023,
    1049628787,
    4261175,
    1049628787,
    8455479,
    1049628787,
    16844087,
    1049628787,
    33621303,
    1049628787,
    2229559,
    1049628787,
    2360631,
    1049628787,
    4457783,
    1049628787,
    8652087,
    1049628787,
    17040695,
    1049628787,
    33817911,
    1049628787,
    2622775,
    1049628787,
    3147063,
    1049628787,
    4719927,
    1049628787,
    5244215,
    1049628787,
    8914231,
    1049628787,
    9438519,
    1049628787,
    17302839,
    1049628787,
    17827127,
    1049628787,
    34080055,
    1049628787,
    34604343,
    1049628787,
    69272887,
    1049628787,
    71370039,
    1049628787,
    75564343,
    1049628787,
    83952951,
    1049628787,
    100730167,
    1049628787,
    69338423,
    1049628787,
    69469495,
    1049628787,
    71566647,
    1049628787,
    75760951,
    1049628787,
    84149559,
    1049628787,
    100926775,
    1049628787,
    69731639,
    1049628787,
    70255927,
    1049628787,
    71828791,
    1049628787,
    72353079,
    1049628787,
    76023095,
    1049628787,
    76547383,
    1049628787,
    84411703,
    1049628787,
    84935991,
    1049628787,
    101188919,
    1049628787,
    101713207,
    1049628787,
    136381751,
    1049628787,
    138478903,
    1049628787,
    142673207,
    1049628787,
    151061815,
    1049628787,
    167839031,
    1049628787,
    136447287,
    1049628787,
    136578359,
    1049628787,
    138675511,
    1049628787,
    142869815,
    1049628787,
    151258423,
    1049628787,
    168035639,
    1049628787,
    136840503,
    1049628787,
    137364791,
    1049628787,
    138937655,
    1049628787,
    139461943,
    1049628787,
    143131959,
    1049628787,
    143656247,
    1049628787,
    151520567,
    1049628787,
    152044855,
    1049628787,
    168297783,
    1049628787,
    168822071,
    1049628787,
    203490615,
    1049628787,
    205587767,
    1049628787,
    209782071,
    1049628787,
    218170679,
    1049628787,
    234947895,
    1049628787,
    203556151,
    1049628787,
    203687223,
    1049628787,
    205784375,
    1049628787,
    209978679,
    1049628787,
    218367287,
    1049628787,
    235144503,
    1049628787,
    203949367,
    1049628787,
    204473655,
    1049628787,
    206046519,
    1049628787,
    206570807,
    1049628787,
    210240823,
    1049628787,
    210765111,
    1049628787,
    218629431,
    1049628787,
    219153719,
    1049628787,
    235406647,
    1049628787,
    235930935,
    1049628787,
    270599479,
    1049628787,
    272696631,
    1049628787,
    276890935,
    1049628787,
    285279543,
    1049628787,
    302056759,
    1049628787,
    270665015,
    1049628787,
    270796087,
    1049628787,
    272893239,
    1049628787,
    277087543,
    1049628787,
    285476151,
    1049628787,
    302253367,
    1049628787,
    271058231,
    1049628787,
    271582519,
    1049628787,
    273155383,
    1049628787,
    273679671,
    1049628787,
    277349687,
    1049628787,
    277873975,
    1049628787,
    285738295,
    1049628787,
    286262583,
    1049628787,
    302515511,
    1049628787,
    303039799,
    1049628787,
    337708343,
    1049628787,
    339805495,
    1049628787,
    343999799,
    1049628787,
    352388407,
    1049628787,
    369165623,
    1049628787,
    337773879,
    1049628787,
    337904951,
    1049628787,
    340002103,
    1049628787,
    344196407,
    1049628787,
    352585015,
    1049628787,
    369362231,
    1049628787,
    338167095,
    1049628787,
    338691383,
    1049628787,
    340264247,
    1049628787,
    340788535,
    1049628787,
    344458551,
    1049628787,
    344982839,
    1049628787,
    352847159,
    1049628787,
    353371447,
    1049628787,
    369624375,
    1049628787,
    370148663,
    1049628787,
    404817207,
    1049628787,
    406914359,
    1049628787,
    411108663,
    1049628787,
    419497271,
    1049628787,
    436274487,
    1049628787,
    404882743,
    1049628787,
    405013815,
    1049628787,
    407110967,
    1049628787,
    411305271,
    1049628787,
    419693879,
    1049628787,
    436471095,
    1049628787,
    405275959,
    1049628787,
    405800247,
    1049628787,
    407373111,
    1049628787,
    407897399,
    1049628787,
    411567415,
    1049628787,
    412091703,
    1049628787,
    419956023,
    1049628787,
    420480311,
    1049628787,
    436733239,
    1049628787,
    437257527,
    1049628787,
    471926071,
    1049628787,
    474023223,
    1049628787,
    478217527,
    1049628787,
    486606135,
    1049628787,
    503383351,
    1049628787,
    471991607,
    1049628787,
    472122679,
    1049628787,
    474219831,
    1049628787,
    478414135,
    1049628787,
    486802743,
    1049628787,
    503579959,
    1049628787,
    472384823,
    1049628787,
    472909111,
    1049628787,
    474481975,
    1049628787,
    475006263,
    1049628787,
    478676279,
    1049628787,
    479200567,
    1049628787,
    487064887,
    1049628787,
    487589175,
    1049628787,
    503842103,
    1049628787,
    504366391,
    1049628787,
    539034935,
    1049628787,
    541132087,
    1049628787,
    545326391,
    1049628787,
    553714999,
    1049628787,
    570492215,
    1049628787,
    539100471,
    1049628787,
    539231543,
    1049628787,
    541328695,
    1049628787,
    545522999,
    1049628787,
    553911607,
    1049628787,
    570688823,
    1049628787,
    539493687,
    1049628787,
    540017975,
    1049628787,
    541590839,
    1049628787,
    542115127,
    1049628787,
    545785143,
    1049628787,
    546309431,
    1049628787,
    554173751,
    1049628787,
    554698039,
    1049628787,
    570950967,
    1049628787,
    571475255,
    1049628787,
    606143799,
    1049628787,
    608240951,
    1049628787,
    612435255,
    1049628787,
    620823863,
    1049628787,
    637601079,
    1049628787,
    606209335,
    1049628787,
    606340407,
    1049628787,
    608437559,
    1049628787,
    612631863,
    1049628787,
    621020471,
    1049628787,
    637797687,
    1049628787,
    606602551,
    1049628787,
    607126839,
    1049628787,
    608699703,
    1049628787,
    609223991,
    1049628787,
    612894007,
    1049628787,
    613418295,
    1049628787,
    621282615,
    1049628787,
    621806903,
    1049628787,
    638059831,
    1049628787,
    638584119,
    1049628787,
    673252663,
    1049628787,
    675349815,
    1049628787,
    679544119,
    1049628787,
    687932727,
    1049628787,
    704709943,
    1049628787,
    673318199,
    1049628787,
    673449271,
    1049628787,
    675546423,
    1049628787,
    679740727,
    1049628787,
    688129335,
    1049628787,
    704906551,
    1049628787,
    673711415,
    1049628787,
    674235703,
    1049628787,
    675808567,
    1049628787,
    676332855,
    1049628787,
    680002871,
    1049628787,
    680527159,
    1049628787,
    688391479,
    1049628787,
    688915767,
    1049628787,
    705168695,
    1049628787,
    705692983,
    1049628787,
    740361527,
    1049628787,
    742458679,
    1049628787,
    746652983,
    1049628787,
    755041591,
    1049628787,
    771818807,
    1049628787,
    740427063,
    1049628787,
    740558135,
    1049628787,
    742655287,
    1049628787,
    746849591,
    1049628787,
    755238199,
    1049628787,
    772015415,
    1049628787,
    740820279,
    1049628787,
    741344567,
    1049628787,
    742917431,
    1049628787,
    743441719,
    1049628787,
    747111735,
    1049628787,
    747636023,
    1049628787,
    755500343,
    1049628787,
    756024631,
    1049628787,
    772277559,
    1049628787,
    772801847,
    1049628787,
    807470391,
    1049628787,
    809567543,
    1049628787,
    813761847,
    1049628787,
    822150455,
    1049628787,
    838927671,
    1049628787,
    807535927,
    1049628787,
    807666999,
    1049628787,
    809764151,
    1049628787,
    813958455,
    1049628787,
    822347063,
    1049628787,
    839124279,
    1049628787,
    807929143,
    1049628787,
    808453431,
    1049628787,
    810026295,
    1049628787,
    810550583,
    1049628787,
    814220599,
    1049628787,
    814744887,
    1049628787,
    822609207,
    1049628787,
    823133495,
    1049628787,
    839386423,
    1049628787,
    839910711,
    1049628787,
    874579255,
    1049628787,
    876676407,
    1049628787,
    880870711,
    1049628787,
    889259319,
    1049628787,
    906036535,
    1049628787,
    874644791,
    1049628787,
    874775863,
    1049628787,
    876873015,
    1049628787,
    881067319,
    1049628787,
    889455927,
    1049628787,
    906233143,
    1049628787,
    875038007,
    1049628787,
    875562295,
    1049628787,
    877135159,
    1049628787,
    877659447,
    1049628787,
    881329463,
    1049628787,
    881853751,
    1049628787,
    889718071,
    1049628787,
    890242359,
    1049628787,
    906495287,
    1049628787,
    907019575,
    1049628787,
    941688119,
    1049628787,
    943785271,
    1049628787,
    947979575,
    1049628787,
    956368183,
    1049628787,
    973145399,
    1049628787,
    941753655,
    1049628787,
    941884727,
    1049628787,
    943981879,
    1049628787,
    948176183,
    1049628787,
    956564791,
    1049628787,
    973342007,
    1049628787,
    942146871,
    1049628787,
    942671159,
    1049628787,
    944244023,
    1049628787,
    944768311,
    1049628787,
    948438327,
    1049628787,
    948962615,
    1049628787,
    956826935,
    1049628787,
    957351223,
    1049628787,
    973604151,
    1049628787,
    974128439,
    1049628787,
    1008796983,
    1049628787,
    1010894135,
    1049628787,
    1015088439,
    1049628787,
    1023477047,
    1049628787,
    1040254263,
    1049628787,
    1008862519,
    1049628787,
    1008993591,
    1049628787,
    1011090743,
    1049628787,
    1015285047,
    1049628787,
    1023673655,
    1049628787,
    1040450871,
    1049628787,
    1009255735,
    1049628787,
    1009780023,
    1049628787,
    1011352887,
    1049628787,
    1011877175,
    1049628787,
    1015547191,
    1049628787,
    1016071479,
    1049628787,
    1023935799,
    1049628787,
    1024460087,
    1049628787,
    1040713015,
    1049628787,
    1041237303,
    1049628787,
    1075905847,
    1049628787,
    1078002999,
    1049628787,
    1082197303,
    1049628787,
    1090585911,
    1049628787,
    1107363127,
    1049628787,
    1075971383,
    1049628787,
    1076102455,
    1049628787,
    1078199607,
    1049628787,
    1082393911,
    1049628787,
    1090782519,
    1049628787,
    1107559735,
    1049628787,
    1076364599,
    1049628787,
    1076888887,
    1049628787,
    1078461751,
    1049628787,
    1078986039,
    1049628787,
    1082656055,
    1049628787,
    1083180343,
    1049628787,
    1091044663,
    1049628787,
    1091568951,
    1049628787,
    1107821879,
    1049628787,
    1108346167,
    1049628787,
    1143014711,
    1049628787,
    1145111863,
    1049628787,
    1149306167,
    1049628787,
    1157694775,
    1049628787,
    1174471991,
    1049628787,
    1143080247,
    1049628787,
    1143211319,
    1049628787,
    1145308471,
    1049628787,
    1149502775,
    1049628787,
    1157891383,
    1049628787,
    1174668599,
    1049628787,
    1143473463,
    1049628787,
    1143997751,
    1049628787,
    1145570615,
    1049628787,
    1146094903,
    1049628787,
    1149764919,
    1049628787,
    1150289207,
    1049628787,
    1158153527,
    1049628787,
    1158677815,
    1049628787,
    1174930743,
    1049628787,
    1175455031,
    1049628787,
    1210123575,
    1049628787,
    1212220727,
    1049628787,
    1216415031,
    1049628787,
    1224803639,
    1049628787,
    1241580855,
    1049628787,
    1210189111,
    1049628787,
    1210320183,
    1049628787,
    1212417335,
    1049628787,
    1216611639,
    1049628787,
    1225000247,
    1049628787,
    1241777463,
    1049628787,
    1210582327,
    1049628787,
    1211106615,
    1049628787,
    1212679479,
    1049628787,
    1213203767,
    1049628787,
    1216873783,
    1049628787,
    1217398071,
    1049628787,
    1225262391,
    1049628787,
    1225786679,
    1049628787,
    1242039607,
    1049628787,
    1242563895,
    1049628787,
    1277232439,
    1049628787,
    1279329591,
    1049628787,
    1283523895,
    1049628787,
    1291912503,
    1049628787,
    1308689719,
    1049628787,
    1277297975,
    1049628787,
    1277429047,
    1049628787,
    1279526199,
    1049628787,
    1283720503,
    1049628787,
    1292109111,
    1049628787,
    1308886327,
    1049628787,
    1277691191,
    1049628787,
    1278215479,
    1049628787,
    1279788343,
    1049628787,
    1280312631,
    1049628787,
    1283982647,
    1049628787,
    1284506935,
    1049628787,
    1292371255,
    1049628787,
    1292895543,
    1049628787,
    1309148471,
    1049628787,
    1309672759,
    1049628787,
    1344341303,
    1049628787,
    1346438455,
    1049628787,
    1350632759,
    1049628787,
    1359021367,
    1049628787,
    1375798583,
    1049628787,
    1344406839,
    1049628787,
    1344537911,
    1049628787,
    1346635063,
    1049628787,
    1350829367,
    1049628787,
    1359217975,
    1049628787,
    1375995191,
    1049628787,
    1344800055,
    1049628787,
    1345324343,
    1049628787,
    1346897207,
    1049628787,
    1347421495,
    1049628787,
    1351091511,
    1049628787,
    1351615799,
    1049628787,
    1359480119,
    1049628787,
    1360004407,
    1049628787,
    1376257335,
    1049628787,
    1376781623,
    1049628787,
    1411450167,
    1049628787,
    1413547319,
    1049628787,
    1417741623,
    1049628787,
    1426130231,
    1049628787,
    1442907447,
    1049628787,
    1411515703,
    1049628787,
    1411646775,
    1049628787,
    1413743927,
    1049628787,
    1417938231,
    1049628787,
    1426326839,
    1049628787,
    1443104055,
    1049628787,
    1411908919,
    1049628787,
    1412433207,
    1049628787,
    1414006071,
    1049628787,
    1414530359,
    1049628787,
    1418200375,
    1049628787,
    1418724663,
    1049628787,
    1426588983,
    1049628787,
    1427113271,
    1049628787,
    1443366199,
    1049628787,
    1443890487,
    1049628787,
    1478559031,
    1049628787,
    1480656183,
    1049628787,
    1484850487,
    1049628787,
    1493239095,
    1049628787,
    1510016311,
    1049628787,
    1478624567,
    1049628787,
    1478755639,
    1049628787,
    1480852791,
    1049628787,
    1485047095,
    1049628787,
    1493435703,
    1049628787,
    1510212919,
    1049628787,
    1479017783,
    1049628787,
    1479542071,
    1049628787,
    1481114935,
    1049628787,
    1481639223,
    1049628787,
    1485309239,
    1049628787,
    1485833527,
    1049628787,
    1493697847,
    1049628787,
    1494222135,
    1049628787,
    1510475063,
    1049628787,
    1510999351,
    1049628787,
    1545667895,
    1049628787,
    1547765047,
    1049628787,
    1551959351,
    1049628787,
    1560347959,
    1049628787,
    1577125175,
    1049628787,
    1545733431,
    1049628787,
    1545864503,
    1049628787,
    1547961655,
    1049628787,
    1552155959,
    1049628787,
    1560544567,
    1049628787,
    1577321783,
    1049628787,
    1546126647,
    1049628787,
    1546650935,
    1049628787,
    1548223799,
    1049628787,
    1548748087,
    1049628787,
    1552418103,
    1049628787,
    1552942391,
    1049628787,
    1560806711,
    1049628787,
    1561330999,
    1049628787,
    1577583927,
    1049628787,
    1578108215,
    1049628787,
    4564227,
    370179,
    2147485367,
    13976883,
    2147518135,
    8816275,
    14042675,
    12951587,
    10854947,
];